<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Unity WebGL Player | Granny 2</title>

    <link rel="shortcut icon"
        href="https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/TemplateData/favicon.ico" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/TemplateData/styles.css" />

    <!-- GameMonetize SDK -->
    <script type="text/javascript">
        window.SDK_OPTIONS = {
            gameId: "jp112o3o4hzgrnc7zaewjkrfk282pul8",
            onEvent: function (a) {
                switch (a.name) {
                    case "SDK_GAME_PAUSE":
                        console.log("Oyun duraklatıldı, ses kapatılıyor...");
                        if (typeof myGameInstance !== 'undefined' && myGameInstance) {
                            myGameInstance.SendMessage('AudioManager', 'MuteAudio');
                        }
                        break;
                    case "SDK_GAME_START":
                        console.log("Reklam bitti, oyun devam ediyor...");
                        if (typeof myGameInstance !== 'undefined' && myGameInstance) {
                            myGameInstance.SendMessage('AudioManager', 'UnmuteAudio');
                        }
                        break;
                    case "SDK_READY":
                        console.log("SDK hazır.");
                        break;
                }
            }
        };
        (function (a, b, c) {
            var d = a.getElementsByTagName(b)[0];
            if (!a.getElementById(c)) {
                var s = a.createElement(b);
                s.id = c;
                s.src = "https://cdn.jsdelivr.net/gh/testamalame/sef@main/sedk.js";
                d.parentNode.insertBefore(s, d);
            }
        })(document, "script", "gamemonetize-sdk");
    </script>
</head>

<body>
    <div id="unity-container" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">
        <canvas id="unity-canvas" style="position: absolute; width: 100%; height: 100%;"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var warningBanner = document.querySelector("#unity-warning");

        let myGameInstance = null;
        let isAdShown = false;

        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type === 'error') {
                div.style = 'background: red; padding: 10px;';
            } else {
                if (type === 'warning') {
                    div.style = 'background: yellow; padding: 10px;';
                }
                setTimeout(function () {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        function showAdOnClick() {
            if (!isAdShown && typeof sdk !== 'undefined' && typeof sdk.showBanner !== 'undefined') {
                sdk.showBanner();
                isAdShown = true;
                console.log("Reklam çağrıldı.");
            } else {
                console.warn("SDK veya showBanner tanımlı değil.");
            }
        }

        let environmentData = {
            language: "en",
            domain: "default_domain",
            deviceType: "desktop",
            isMobile: false,
            isDesktop: true,
            isTablet: false,
            isTV: false,
            appID: "default_app_id",
            browserLang: navigator.language || "en",
            payload: null,
            promptCanShow: false,
            reviewCanShow: false,
            platform: navigator.platform,
            browser: (function () {
                let userAgent = navigator.userAgent;
                if (userAgent.includes("YaBrowser")) return "Yandex";
                if (userAgent.includes("OPR") || userAgent.includes("Opera")) return "Opera";
                if (userAgent.includes("Firefox")) return "Firefox";
                if (userAgent.includes("MSIE") || userAgent.includes("Trident")) return "IE";
                if (userAgent.includes("Edge")) return "Edge";
                if (userAgent.includes("Chrome")) return "Chrome";
                if (userAgent.includes("Safari")) return "Safari";
                return "Other";
            })()

        }; const dataParts = [
            "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build/Granny%202_part1.data",
            "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build/Granny%202_part2.data",
            "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build/Granny%202_part3.data"
        ];

        const wasmParts = [
            "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build/Granny%202_part1.wasm",
            "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build/Granny%202_part2.wasm"
        ];

        async function mergeFiles(parts, onProgress) {
            let loaded = 0;
            const total = parts.length;

            const blobs = await Promise.all(parts.map(async (part) => {
                const response = await fetch(part);
                if (!response.ok) {
                    throw new Error(`Failed to load ${part}: ${response.status}`);
                }

                const blob = await response.blob();
                loaded++;
                if (onProgress) onProgress(loaded / total);
                return blob;
            }));

            return new Blob(blobs, { type: blobs[0].type });
        }

        const buildUrl = "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build";
        const loaderUrl = buildUrl + "/Granny%202.loader.js";

        async function initializeGame() {
        console.log("Environment Data:", environmentData);
        loadingBar.style.display = "block";
        console.log("Loading bar displayed.");


        try {
            var dataUrl = URL.createObjectURL(await mergeFiles(dataParts, progress => {
                progressBarFull.style.width = (50 * progress) + "%";
            }));
            var wasmUrl = URL.createObjectURL(await mergeFiles(wasmParts, progress => {
                progressBarFull.style.width = (50 + 50 * progress) + "%";
            }));
        } catch (e) {
            console.error("Error while fetching/merging parts", e);
            unityShowBanner("Failed to load game data.", "error");
            return;
        }

        var config = {
            dataUrl: dataUrl,
            frameworkUrl: buildUrl + "/Granny%202.framework.js",
            codeUrl: wasmUrl,
            streamingAssetsUrl: "StreamingAssets",
            companyName: "Awesome",
            productName: "Granny 2",
            productVersion: "1.0",
            showBanner: unityShowBanner,
        };

        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                progressBarFull.style.width = (100 * progress) + "%";
            }).then((unityInstance) => {
                URL.revokeObjectURL(dataUrl);
                URL.revokeObjectURL(wasmUrl);
                myGameInstance = unityInstance;
                setTimeout(() => { loadingBar.style.display = "none"; }, 500);
                canvas.addEventListener('pointerdown', showAdOnClick);
                canvas.addEventListener('touchstart', showAdOnClick);
            }).catch((message) => {
                console.error("Unity createUnityInstance error:", message);
                alert(message);
            });
        };
        document.body.appendChild(script);
        }

        initializeGame();
    </script>

    <!-- Sticky Bottom Center Ad (728x90) -->
    <style>
        #ad-container {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: min(728px, calc(100% - 20px));
            height: 90px;
            background: rgba(0, 0, 0, 0.90);
            display: none;
            z-index: 99999;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.45);
            box-sizing: border-box;
            transition: transform 0.5s ease-in-out;
        }

        #ad-container.hidden {
            transform: translate(-50%, 100%);
        }

        #ad-iframe {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 745px;
            height: 90px;
            border: 0;
            display: block;
            overflow: hidden;
            pointer-events: auto;
            box-sizing: content-box;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #ad-iframe::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        #close-ad {
            position: absolute;
            top: 6px;
            right: 8px;
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 9px;
            font-size: 13px;
            border-radius: 4px;
            cursor: not-allowed;
            opacity: 0.72;
            z-index: 100000;
            display: flex;
            align-items: center;
        }

        #close-ad.enabled {
            cursor: pointer;
            opacity: 1;
        }

        #close-ad::before {
            content: '↓';
            margin-right: 4px;
        }

        #ad-right-mask {
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.9));
            z-index: 99999;
        }

        @media (max-width: 440px) {
            #ad-container {
                width: calc(100% - 12px);
                left: 50%;
                transform: translateX(-50%);
                border-radius: 0;
            }

            #ad-iframe {
                width: 728px;
            }
        }
    </style>

    <div id="ad-container" aria-hidden="true" role="dialog" aria-label="Advertisement">
        <iframe id="ad-iframe"
            src="https://script.google.com/macros/s/AKfycbzA6GNdpfUShkCh6apD0D21YAUf7A5d3Guhq2PayqLbk_5XG_wQhy0bdYzKJWLhzgMVMQ/exec"
            width="768px" height="95px" scrolling="no" frameborder="0"
            sandbox="allow-scripts allow-popups allow-same-origin">
        </iframe>
        <button id="close-ad" disabled>Close (12)</button>
        <div id="ad-right-mask"></div>
    </div>

    <script>
        (function () {
            const showDelay = 2000;
            const countdownStart = 12;
            const reappearDelay = 25000;
            const adContainer = document.getElementById('ad-container');
            const closeBtn = document.getElementById('close-ad');

            function showAd() {
                adContainer.style.display = 'block';
                adContainer.classList.remove('hidden');
                adContainer.setAttribute('aria-hidden', 'false');

                let timeLeft = countdownStart;
                closeBtn.textContent = `Close (${timeLeft})`;
                closeBtn.disabled = true;
                closeBtn.classList.remove('enabled');

                const t = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        closeBtn.textContent = `Close (${timeLeft})`;
                    } else {
                        clearInterval(t);
                        closeBtn.disabled = false;
                        closeBtn.classList.add('enabled');
                        closeBtn.textContent = 'Close ↓';
                    }
                }, 1000);
            }

            setTimeout(showAd, showDelay);

            closeBtn.addEventListener('click', () => {
                if (closeBtn.disabled) return;
                adContainer.classList.add('hidden');
                adContainer.setAttribute('aria-hidden', 'true');
                setTimeout(showAd, reappearDelay);
            });
        })();
    </script>
</body>

</html>
