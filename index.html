<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Math Solver | Advanced Calculus</title>
    <meta name="description" content="Advanced online calculus solver and graphing tool for students. Free educational resources for math." />
    <meta name="keywords" content="math, calculus, solver, education, graph, calculator" />
    <meta name="referrer" content="no-referrer" />

    <link rel="shortcut icon"
        href="https://ssl.gstatic.com/classroom/favicon.png" />
    <link rel="stylesheet"
        href="TemplateData/styles.css" />

    <!-- Page Enhancement -->
    <script>
        // Cosmetic: Change the URL in the address bar
        if (window.history && window.history.replaceState) {
            window.history.replaceState({}, atob("R29vZ2xlIENsYXNzcm9vbQ=="), "/u/0/c/Calculus_AP/materials/view");
        }

        // Advanced: Open in about:blank to hide from extensions/history (Press ']' to activate)
        document.addEventListener('keydown', function(event) {
            if (event.key === ']') {
                var win = window.open('about:blank', '_blank');
                if (win) {
                    win.document.body.style.margin = '0';
                    win.document.body.style.overflow = 'hidden';
                    var iframe = win.document.createElement('iframe');
                    iframe.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; border:none;";
                    iframe.src = window.location.href;
                    win.document.body.appendChild(iframe);
                }
            }
        });
    </script>

    <!-- Preload critical game assets to start downloading them sooner -->
    <link rel="preload" href="Build/g.loader.js" as="script">
    <link rel="preload" href="Build/g.framework.js" as="script">
    <link rel="preload" href="Build/g_1.data" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="Build/g_2.data" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="Build/g_3.data" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="Build/g_1.wasm" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="Build/g_2.wasm" as="fetch" crossorigin="anonymous">

    <!-- Third-party SDK -->
    <script type="text/javascript">
        window.SDK_OPTIONS = {
            gameId: "jp112o3o4hzgrnc7zaewjkrfk282pul8",
            onEvent: function (a) {
                switch (a.name) {
                    case "SDK_GAME_PAUSE":
                        console.log("Oyun duraklatıldı, ses kapatılıyor...");
                        if (typeof myGameInstance !== 'undefined' && myGameInstance) {
                            myGameInstance.SendMessage('AudioManager', 'MuteAudio');
                        }
                        break;
                    case "SDK_GAME_START":
                        console.log("Reklam bitti, oyun devam ediyor...");
                        if (typeof myGameInstance !== 'undefined' && myGameInstance) {
                            myGameInstance.SendMessage('AudioManager', 'UnmuteAudio');
                        }
                        break;
                    case "SDK_READY":
                        console.log("SDK hazır.");
                        break;
                }
            }
        };
        (function (a, b, c) {
            var d = a.getElementsByTagName(b)[0];
            if (!a.getElementById(c)) {
                var s = a.createElement(b);
                s.id = c;
                s.src = "Build/sdk.js";
                d.parentNode.insertBefore(s, d);
            }
        })(document, "script", "gamemonetize-sdk");
    </script>
</head>

<body>
    <div id="unity-container" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">
        <canvas id="unity-canvas" style="position: absolute; width: 100%; height: 100%;"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo" style="display: none;"></div>
            <div style="margin-bottom: 15px; font-family: sans-serif; color: #555; font-weight: bold; text-align: center;">Loading Graphing Engine...</div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var warningBanner = document.querySelector("#unity-warning");

        let myGameInstance = null;
        let isAdShown = false;

        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type === 'error') {
                div.style = 'background: red; padding: 10px;';
            } else {
                if (type === 'warning') {
                    div.style = 'background: yellow; padding: 10px;';
                }
                setTimeout(function () {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        function showAdOnClick() {
            if (!isAdShown && typeof sdk !== 'undefined' && typeof sdk.showBanner !== 'undefined') {
                sdk.showBanner();
                isAdShown = true;
                console.log("Reklam çağrıldı.");
            } else {
                console.warn("SDK veya showBanner tanımlı değil.");
            }
        }

        let environmentData = {
            language: "en",
            domain: window.location.hostname,
            deviceType: "desktop",
            isMobile: false,
            isDesktop: true,
            isTablet: false,
            isTV: false,
            appID: "default_app_id",
            browserLang: navigator.language || "en",
            payload: null,
            promptCanShow: false,
            reviewCanShow: false,
            platform: navigator.platform,
            browser: (function () {
                let userAgent = navigator.userAgent;
                if (userAgent.includes("YaBrowser")) return "Yandex";
                if (userAgent.includes("OPR") || userAgent.includes("Opera")) return "Opera";
                if (userAgent.includes("Firefox")) return "Firefox";
                if (userAgent.includes("MSIE") || userAgent.includes("Trident")) return "IE";
                if (userAgent.includes("Edge")) return "Edge";
                if (userAgent.includes("Chrome")) return "Chrome";
                if (userAgent.includes("Safari")) return "Safari";
                return "Other";
            })()

        }; const dataParts = [
            "Build/g_1.data",
            "Build/g_2.data",
            "Build/g_3.data"
        ];

        const wasmParts = [
            "Build/g_1.wasm",
            "Build/g_2.wasm"
        ];

        async function mergeFiles(parts, onProgress) {
            let loaded = 0;
            const total = parts.length;

            const blobs = await Promise.all(parts.map(async (part) => {
                const response = await fetch(part);
                if (!response.ok) {
                    throw new Error(`Failed to load ${part}: ${response.status}`);
                }

                const blob = await response.blob();
                loaded++;
                if (onProgress) onProgress(loaded / total);
                return blob;
            }));

            return new Blob(blobs, { type: blobs[0].type });
        }

        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/g.loader.js";

        async function initializeGame() {
            console.log("Environment Data:", environmentData);
            loadingBar.style.display = "block";
            console.log("Loading bar displayed.");

            // Start loading the Unity loader script early, in parallel with other assets.
            const loaderScriptPromise = new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = loaderUrl;
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });

            try {
                let dataProgress = 0;
                let wasmProgress = 0;

                const updateFileLoadProgressBar = () => {
                    // Weigh progress by number of parts for a more accurate loading bar.
                    const totalParts = dataParts.length + wasmParts.length;
                    const weightedProgress = (dataProgress * dataParts.length + wasmProgress * wasmParts.length) / totalParts;
                    // File loading will take up the first 90% of the progress bar.
                    progressBarFull.style.width = (weightedProgress * 90) + "%";
                };

                // In parallel, fetch and merge game data/code parts.
                const [dataBlob, wasmBlob] = await Promise.all([
                    mergeFiles(dataParts, progress => {
                        dataProgress = progress;
                        updateFileLoadProgressBar();
                    }),
                    mergeFiles(wasmParts, progress => {
                        wasmProgress = progress;
                        updateFileLoadProgressBar();
                    })
                ]);

                const dataUrl = URL.createObjectURL(dataBlob);
                const wasmUrl = URL.createObjectURL(wasmBlob);

                const config = {
                    dataUrl: dataUrl,
                    frameworkUrl: buildUrl + "/g.framework.js",
                    codeUrl: wasmUrl,
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "Awesome",
                    productName: "Math Solver",
                    productVersion: "1.0",
                    showBanner: unityShowBanner,
                };

                // Wait for the loader script to be ready before creating the instance.
                await loaderScriptPromise;

                createUnityInstance(canvas, config, (progress) => {
                    // Unity instance creation progress. This will run after file loading is complete.
                    // We'll use it for the final 10% of the progress bar.
                    progressBarFull.style.width = 90 + (progress * 10) + "%";
                }).then((unityInstance) => {
                    URL.revokeObjectURL(dataUrl);
                    URL.revokeObjectURL(wasmUrl);
                    myGameInstance = unityInstance;
                    // Finalizing, hide loading bar.
                    progressBarFull.style.width = "100%";
                    setTimeout(() => { loadingBar.style.display = "none"; }, 500);
                    canvas.addEventListener('pointerdown', showAdOnClick);
                    canvas.addEventListener('touchstart', showAdOnClick);
                }).catch((message) => {
                    console.error("Unity createUnityInstance error:", message);
                    alert(message);
                });
            } catch (e) {
                console.error("Error while fetching/merging parts or loading script", e);
                unityShowBanner("Failed to load game data.", "error");
                return;
            }
        }

        initializeGame();
    </script>

    <!-- Hotkey Action -->
    <script>
        document.addEventListener('keydown', function(event) {
            if (event.key === '\\' || event.key === '|') {
                // Prevent the key from doing anything else and mute audio immediately
                event.preventDefault();
                if (typeof myGameInstance !== 'undefined' && myGameInstance) {
                    try { myGameInstance.SendMessage('AudioManager', 'MuteAudio'); } catch(e) {}
                }
                window.location.replace(atob("aHR0cHM6Ly9jbGFzc3Jvb20uZ29vZ2xlLmNvbQ=="));
            }
        });
    </script>

    <!-- Sticky Bottom Center Ad (728x90) -->
    <style>
        #b-cont {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: min(728px, calc(100% - 20px));
            height: 90px;
            background: rgba(0, 0, 0, 0.90);
            display: none;
            z-index: 99999;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.45);
            box-sizing: border-box;
            transition: transform 0.5s ease-in-out;
        }

        #b-cont.hidden {
            transform: translate(-50%, 100%);
        }

        #b-frame {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 745px;
            height: 90px;
            border: 0;
            display: block;
            overflow: hidden;
            pointer-events: auto;
            box-sizing: content-box;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #b-frame::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        #b-close {
            position: absolute;
            top: 6px;
            right: 8px;
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 9px;
            font-size: 13px;
            border-radius: 4px;
            cursor: not-allowed;
            opacity: 0.72;
            z-index: 100000;
            display: flex;
            align-items: center;
        }

        #b-close.enabled {
            cursor: pointer;
            opacity: 1;
        }

        #b-close::before {
            content: '↓';
            margin-right: 4px;
        }

        #b-mask {
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.9));
            z-index: 99999;
        }

        @media (max-width: 440px) {
            #b-cont {
                width: calc(100% - 12px);
                left: 50%;
                transform: translateX(-50%);
                border-radius: 0;
            }

            #b-frame {
                width: 728px;
            }
        }
    </style>

    <div id="b-cont" aria-hidden="true" role="dialog" aria-label="Advertisement">
        <iframe id="b-frame"
            width="768px" height="95px" scrolling="no" frameborder="0"
            sandbox="allow-scripts allow-popups allow-same-origin">
        </iframe>
        <button id="b-close" disabled>Close (12)</button>
        <div id="b-mask"></div>
    </div>

    <script>
        (function () {
            const adIframe = document.getElementById('ad-iframe');
            const p1 = 'https://script.google.com/macros/s/';
            const encoded_p2 = 'QUpmdWNiMEduZHBmVVNoa0NoNmFwRDBEMjFZQVVmN0E1ZDNHeWhxMlBheXFMYmtfNVhHX3dRaHkwYmRZekpKV0xoemhNVk1RL2V4ZWM=';
            adIframe.src = p1 + atob(encoded_p2);

            const showDelay = 2000;
            const countdownStart = 12;
            const reappearDelay = 25000;
            const adContainer = document.getElementById('ad-container');
            const closeBtn = document.getElementById('close-ad');

            function showAd() {
                adContainer.style.display = 'block';
                adContainer.classList.remove('hidden');
                adContainer.setAttribute('aria-hidden', 'false');

                let timeLeft = countdownStart;
                closeBtn.textContent = `Close (${timeLeft})`;
                closeBtn.disabled = true;
                closeBtn.classList.remove('enabled');

                const t = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        closeBtn.textContent = `Close (${timeLeft})`;
                    } else {
                        clearInterval(t);
                        closeBtn.disabled = false;
                        closeBtn.classList.add('enabled');
                        closeBtn.textContent = 'Close ↓';
                    }
                }, 1000);
            }

            setTimeout(showAd, showDelay);

            closeBtn.addEventListener('click', () => {
                if (closeBtn.disabled) return;
                adContainer.classList.add('hidden');
                adContainer.setAttribute('aria-hidden', 'true');
                setTimeout(showAd, reappearDelay);
            });
        })();
    </script>
</body>

</html>
